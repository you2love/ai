<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP协议详解 - AI技术学习平台</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Prism.js syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
</head>
<body>
    <section class="section">
        <div class="container">
            <h2 class="section-title">🔌 MCP协议详解</h2>
            <p class="section-subtitle">Model Context Protocol - AI工具连接标准</p>

            <!-- 什么是MCP -->
            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <div class="card-icon">🔌</div>
                    <div>
                        <div class="card-title">什么是MCP？</div>
                        <div class="card-subtitle">Model Context Protocol</div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="diagram-box">
                        <div class="diagram-title">MCP是什么</div>
                        <div class="diagram-content">
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  MCP = AI应用连接外部工具和数据的标准化协议                      │
│                                                                 │
│  发布：Anthropic 2024年11月                                     │
│                                                                 │
│  核心价值：                                                      │
│  ✓ 统一接口 - 不同工具使用相同协议                              │
│  ✓ 可扩展 - 轻松添加新工具                                      │
│  ✓ 安全 - 明确的权限控制                                        │
│  ✓ 互操作 - 不同AI框架共用工具                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                        </div>
                    </div>

                    <div class="comparison-row" style="margin-top: 1rem;">
                        <div class="comparison-cell" style="font-weight:600;">组件</div>
                        <div class="comparison-cell" style="background:#fef2f2;">MCP Client</div>
                        <div class="comparison-cell" style="background:#ecfdf5;">MCP Server</div>
                    </div>
                    <div class="comparison-row">
                        <div class="comparison-cell">角色</div>
                        <div class="comparison-cell">AI应用端</div>
                        <div class="comparison-cell">工具/数据端</div>
                    </div>
                    <div class="comparison-row">
                        <div class="comparison-cell">职责</div>
                        <div class="comparison-cell">发送请求</div>
                        <div class="comparison-cell">提供服务</div>
                    </div>
                </div>
            </div>

            <!-- 核心组件 -->
            <h3 style="margin: 2rem 0 1rem; font-size: 1.3rem;">🏗️ MCP核心组件</h3>

            <div class="cards-grid">
                <div class="card">
                    <h4 style="margin-bottom: 0.75rem;">📡 传输层</h4>
                    <div class="tags">
                        <span class="tag">Stdio</span>
                        <span class="tag">HTTP</span>
                        <span class="tag">WebSocket</span>
                    </div>
                    <p style="font-size:0.85rem; margin-top:0.75rem; color:#666;">
                        负责数据传输，支持多种通信方式
                    </p>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 0.75rem;">🛠️ 工具 (Tools)</h4>
                    <p style="font-size:0.85rem; color:#666;">AI可调用的函数或API</p>
                    <ul style="font-size:0.8rem; padding-left:1rem; margin-top:0.5rem;">
                        <li>搜索工具</li>
                        <li>计算工具</li>
                        <li>数据库查询</li>
                    </ul>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 0.75rem;">📦 资源 (Resources)</h4>
                    <p style="font-size:0.85rem; color:#666;">可访问的数据和文档</p>
                    <ul style="font-size:0.8rem; padding-left:1rem; margin-top:0.5rem;">
                        <li>文件内容</li>
                        <li>API响应</li>
                        <li>数据库记录</li>
                    </ul>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 0.75rem;">💬 提示 (Prompts)</h4>
                    <p style="font-size:0.85rem; color:#666;">预定义的提示模板</p>
                    <ul style="font-size:0.8rem; padding-left:1rem; margin-top:0.5rem;">
                        <li>任务模板</li>
                        <li>工作流模板</li>
                    </ul>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 0.75rem;">📊 采样 (Sampling)</h4>
                    <p style="font-size:0.85rem; color:#666;">LLM生成过程中的控制</p>
                    <ul style="font-size:0.8rem; padding-left:1rem; margin-top:0.5rem;">
                        <li>温度控制</li>
                        <li>最大token</li>
                    </ul>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 0.75rem;">🔐 安全</h4>
                    <p style="font-size:0.85rem; color:#666;">权限和沙箱机制</p>
                    <ul style="font-size:0.8rem; padding-left:1rem; margin-top:0.5rem;">
                        <li>工具白名单</li>
                        <li>资源访问控制</li>
                    </ul>
                </div>
            </div>

            <!-- 工作流程 -->
            <h3 style="margin: 2rem 0 1rem; font-size: 1.3rem;">🔄 MCP工作流程</h3>

            <div class="flow-chart">
                <div class="flow-item start">AI请求工具</div>
                <div class="flow-arrow">↓</div>
                <div class="flow-item">Client发送请求</div>
                <div class="flow-arrow">↓</div>
                <div class="flow-item">Server处理</div>
                <div class="flow-arrow">↓</div>
                <div class="flow-item">返回结果</div>
                <div class="flow-arrow">↓</div>
                <div class="flow-item end">AI使用结果</div>
            </div>

            <!-- 消息类型 -->
            <h3 style="margin: 2rem 0 1rem; font-size: 1.3rem;">💬 消息类型</h3>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>消息类型</th>
                            <th>方向</th>
                            <th>说明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td><strong>initialize</strong></td><td>双向</td><td>建立连接</td></tr>
                        <tr><td><strong>notifications/init</strong></td><td>Client→Server</td><td>初始化完成</td></tr>
                        <tr><td><strong>tools/list</strong></td><td>Client→Server</td><td>列出工具</td></tr>
                        <tr><td><strong>tools/call</strong></td><td>Client→Server</td><td>调用工具</td></tr>
                        <tr><td><strong>resources/list</strong></td><td>Client→Server</td><td>列出资源</td></tr>
                        <tr><td><strong>resources/read</strong></td><td>Client→Server</td><td>读取资源</td></tr>
                        <tr><td><strong>sampling/create</strong></td><td>Client→Server</td><td>请求采样</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- 与传统方案对比 -->
            <h3 style="margin: 2rem 0 1rem; font-size: 1.3rem;">⚖️ MCP vs 传统方案</h3>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>特性</th>
                            <th>MCP</th>
                            <th>传统方案</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td><strong>标准化</strong></td><td>统一协议</td><td>各自为政</td></tr>
                        <tr><td><strong>工具发现</strong></td><td>动态发现</td><td>静态注册</td></tr>
                        <tr><td><strong>扩展性</strong></td><td>即插即用</td><td>需修改代码</td></tr>
                        <tr><td><strong>安全性</strong></td><td>沙箱机制</td><td>依赖实现</td></tr>
                        <tr><td><strong>互操作</strong></td><td>框架无关</td><td>框架绑定</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- 应用场景 -->
            <h3 style="margin: 2rem 0 1rem; font-size: 1.3rem;">🚀 应用场景</h3>

            <div class="cards-grid">
                <div class="card">
                    <h4 style="margin-bottom: 0.5rem;">🔍 增强搜索</h4>
                    <p style="font-size:0.85rem; color:#666;">AI连接搜索引擎、向量库</p>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 0.5rem;">💻 代码助手</h4>
                    <p style="font-size:0.85rem; color:#666;">访问代码库、API文档</p>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 0.5rem;">📊 数据分析</h4>
                    <p style="font-size:0.85rem; color:#666;">连接数据库、BI工具</p>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 0.5rem;">🌐 Web服务</h4>
                    <p style="font-size:0.85rem; color:#666;">调用第三方API</p>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 0.5rem;">📝 文档处理</h4>
                    <p style="font-size:0.85rem; color:#666;">读取PDF、Word等</p>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 0.5rem;">🔧 工作流</h4>
                    <p style="font-size:0.85rem; color:#666;">编排复杂任务</p>
                </div>
            </div>

            <h3>💻 代码示例</h3>

            <div class="card">
                <div class="card-header">示例：使用MCP协议创建工具Server</div>
                <pre class="code-block"><code class="language-python">"""
MCP协议示例：创建自定义工具Server
- 文件操作工具
- 数据库查询工具
- API调用工具
"""
from typing import Any, Dict, List, Optional
from pydantic import BaseModel
import json
import sqlite3
import requests
from datetime import datetime

# 1. 定义工具Schema (符合MCP规范)
class ToolSchema(BaseModel):
    name: str
    description: str
    inputSchema: Dict

class ToolResult(BaseModel):
    content: Any
    isError: bool = False

# 2. 文件操作工具
class FileOperationTool:
    """文件操作工具 - 符合MCP Tool规范"""
    
    @staticmethod
    def get_schema() -> Dict:
        return {
            "name": "file_operations",
            "description": "读取、写入、列出文件",
            "inputSchema": {
                "type": "object",
                "properties": {
                    "operation": {
                        "type": "string",
                        "enum": ["read", "write", "list", "delete"],
                        "description": "操作类型"
                    },
                    "path": {"type": "string", "description": "文件路径"},
                    "content": {"type": "string", "description": "写入内容"}
                },
                "required": ["operation", "path"]
            }
        }
    
    def execute(self, operation: str, path: str, content: str = None) -> ToolResult:
        try:
            if operation == "read":
                with open(path, "r", encoding="utf-8") as f:
                    return ToolResult(content=f.read())
            
            elif operation == "write":
                with open(path, "w", encoding="utf-8") as f:
                    f.write(content)
                return ToolResult(content=f"已写入: {path}")
            
            elif operation == "list":
                import os
                files = os.listdir(path)
                return ToolResult(content=json.dumps(files))
            
            elif operation == "delete":
                import os
                if os.path.exists(path):
                    os.remove(path)
                    return ToolResult(content=f"已删除: {path}")
                return ToolResult(content=f"文件不存在: {path}")
        
        except Exception as e:
            return ToolResult(content=str(e), isError=True)

# 3. 数据库查询工具
class DatabaseQueryTool:
    """数据库查询工具 - 符合MCP Tool规范"""
    
    def __init__(self, db_path: str = ":memory:"):
        self.conn = sqlite3.connect(db_path)
        self.create_sample_data()
    
    def create_sample_data(self):
        cursor = self.conn.cursor()
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY,
                name TEXT,
                email TEXT,
                age INTEGER
            )
        """)
        cursor.execute("INSERT OR IGNORE INTO users (id, name, email, age) VALUES (1, '张三', 'zhangsan@example.com', 25)")
        cursor.execute("INSERT OR IGNORE INTO users (id, name, email, age) VALUES (2, '李四', 'lisi@example.com', 30)")
        self.conn.commit()
    
    def get_schema(self) -> Dict:
        return {
            "name": "database_query",
            "description": "执行SQL查询",
            "inputSchema": {
                "type": "object",
                "properties": {
                    "query": {"type": "string", "description": "SQL查询语句"},
                    "params": {"type": "array", "description": "查询参数"}
                },
                "required": ["query"]
            }
        }
    
    def execute(self, query: str, params: List = None) -> ToolResult:
        try:
            cursor = self.conn.cursor()
            cursor.execute(query, params or [])
            
            if query.strip().upper().startswith("SELECT"):
                results = cursor.fetchall()
                columns = [desc[0] for desc in cursor.description]
                return ToolResult(content=json.dumps({
                    "columns": columns,
                    "rows": results,
                    "count": len(results)
                }))
            else:
                self.conn.commit()
                return ToolResult(content=f"影响行数: {cursor.rowcount}")
        
        except Exception as e:
            return ToolResult(content=str(e), isError=True)

# 4. API调用工具
class APICallTool:
    """API调用工具 - 符合MCP Tool规范"""
    
    def get_schema(self) -> Dict:
        return {
            "name": "api_call",
            "description": "发送HTTP请求",
            "inputSchema": {
                "type": "object",
                "properties": {
                    "url": {"type": "string", "description": "API地址"},
                    "method": {"type": "string", "enum": ["GET", "POST", "PUT", "DELETE"]},
                    "headers": {"type": "object", "description": "请求头"},
                    "data": {"type": "object", "description": "请求数据"}
                },
                "required": ["url", "method"]
            }
        }
    
    def execute(self, url: str, method: str, headers: Dict = None, data: Dict = None) -> ToolResult:
        try:
            response = requests.request(
                method=method,
                url=url,
                headers=headers or {},
                json=data
            )
            return ToolResult(content=json.dumps({
                "status_code": response.status_code,
                "response": response.json() if response.headers.get("content-type", "").startswith("application/json") else response.text
            }))
        except Exception as e:
            return ToolResult(content=str(e), isError=True)

# 5. MCP Server实现
class MCPServer:
    """MCP Server - 管理所有工具"""
    
    def __init__(self):
        self.tools = [
            FileOperationTool(),
            DatabaseQueryTool(),
            APICallTool()
        ]
        self.tool_schemas = [t.get_schema() for t in self.tools]
    
    def list_tools(self) -> List[Dict]:
        """返回所有工具Schema - MCP协议"""
        return self.tool_schemas
    
    def call_tool(self, name: str, arguments: Dict) -> Dict:
        """调用工具 - MCP协议核心"""
        for tool in self.tools:
            if tool.get_schema()["name"] == name:
                result = tool.execute(**arguments)
                return {
                    "content": [{"type": "text", "text": result.content}],
                    "isError": result.isError
                }
        return {"error": f"Tool not found: {name}", "isError": True}


# 使用示例
def main():
    # 1. 创建MCP Server
    server = MCPServer()
    
    # 2. 列出可用工具 (MCP协议: tools/list)
    print("📋 可用工具:")
    for tool in server.list_tools():
        print(f"  - {tool['name']}: {tool['description']}")
    
    # 3. 调用文件读取工具 (MCP协议: tools/call)
    print("\n📄 读取文件:")
    result = server.call_tool("file_operations", {
        "operation": "list",
        "path": "."
    })
    print(f"  结果: {result}")
    
    # 4. 调用数据库查询工具
    print("\n🗄️ 查询数据库:")
    result = server.call_tool("database_query", {
        "query": "SELECT * FROM users WHERE age > ?",
        "params": [25]
    })
    print(f"  结果: {result}")

main()</code></pre>
            </div>

            <div class="card">
                <div class="card-header">代码说明</div>
                <div class="cards-grid" style="margin-top: 1rem;">
                    <div class="card" style="padding: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">🛠️ 工具类型</h4>
                        <ul style="font-size: 0.85rem; padding-left: 1.2rem;">
                            <li>FileOperationTool - 文件操作</li>
                            <li>DatabaseQueryTool - 数据库</li>
                            <li>APICallTool - HTTP请求</li>
                        </ul>
                    </div>
                    <div class="card" style="padding: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">📡 MCP协议规范</h4>
                        <ul style="font-size: 0.85rem; padding-left: 1.2rem;">
                            <li>tools/list - 列出工具</li>
                            <li>tools/call - 调用工具</li>
                            <li>inputSchema - 输入规范</li>
                        </ul>
                    </div>
                    <div class="card" style="padding: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">🔄 工作流程</h4>
                        <ul style="font-size: 0.85rem; padding-left: 1.2rem;">
                            <li>Server注册工具</li>
                            <li>Client获取Schema</li>
                            <li>Client调用工具</li>
                            <li>返回执行结果</li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </section>
    <!-- Prism.js syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
</body>
</html>